#!/bin/sh

RED="\033[1;31m";
GREEN="\033[1;32m";
NOCL="\033[m";

OK="${GREEN}ГОТОВО${NOCL}"
FAIL="${RED}ПРОБЛЕМА${NOCL}"

LENGTH=66
function diff_len(){
	charlen=$(echo "${1}" | sed -r "s/[\]033\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g")
	charlen=${#charlen}
	echo $(( LENGTH - charlen ))
}
function please_repeat(){
  echo -e "Пожалуйста ответьте на вопрос ${RED}'Y' - да${NOCL} или ${GREEN}'N' - нет${NOCL}."
}
function ready(){
  size=$(diff_len "${1}")
	printf "%b%-${size}s%b" "${1}"
}
function warning(){
	_error="${GREEN}${1}${NOCL}"
	size=$(diff_len "${_error}")
	printf "%b%-${size}s%b\n" "${_error}"
}
print_line() {
	len=$((LENGTH + 12))
	printf "%${len}s\n" | tr " " "-"
}

rm_package_files(){
	rm -rf /opt/etc/{kvas.list,adblock.sources}
	rm -f /opt/etc/ndm/netfilter.d/100-vpn-mark
	rm -f /opt/etc/ndm/ifstatechanged.d/100-unblock-vpn
	rm -rf /opt/tmp/adblock
	rm -f /opt/bin/kvas*
	rm -fr /opt/apps/kvas
}

print_line
echo -e "Удаление пакета ${GREEN}КВАС™ [Kvas™]${NOCL} версия ${GREEN}1.0-beta_10${NOCL}..."
print_line

while true; do
	ready "${RED}Удалить файлы конфигурации пакета${NOCL} [Y/N]? "
	read -r ynq
	case ${ynq} in
		[Yy]* )
			ready "Удаляем файлы конфигурации ${GREEN}'kvas'${NOCL}..."
			rm_package_files
			[ -f /opt/etc/shadowsocks.json.old ] && cp /opt/etc/shadowsocks.json.old /opt/etc/shadowsocks.json
			[ $? = 0 ] && echo -e "${OK}" || echo -e "${FAIL}"
			break;;
		[NnqQ]* )
			break;;
		* ) please_repeat
		;;
	esac
done

ready "${RED}Удаляем данные из cron${NOCL}...     "
sed -i '/kvas_ipset/d' /opt/etc/crontab &>/dev/null
[ $? = 0 ] && echo -e "${OK}" || echo -e "${FAIL}"

print_line
echo "При установке пакета КВАС были установлены следующие пакеты:"
warning "shadowsocks-libev-ss-redir knot-dig iptables curl cron libpcre"
warning "shadowsocks-libev-config dnsmasq-full nano-full bind-dig ipset"
echo "Если данные пакеты Вами больше не используются, Вы можете"
echo -e "их удалить следующей командой: ${RED}opkg remove <имя пакета>${NOCL}"
print_line
