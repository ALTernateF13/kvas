#!/bin/sh
. /opt/bin/kvas/libs/ndm

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания новых правил маркировки трифика по пртоколу IPv4
#	при использовании VPN подключения отличного от shadowsocks.
#	Они срабатывают при пепезаписи правил в таблице netfilter
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#	основными задачами являются:
#
#	1. Создание unblock для ipset ip4
#	2. Проверка на наличие ускорения трафика (аппартаное и программное)
#	3. В зависимости от наличия ускорения включаем те или иные правила маркировки трафика
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------


# Пропускаем обработку, если тип подключения отличен от iptables
# а сама талица отлична от mangle
[ "$type" != "iptables" ] && exit 0
[ "$table" != "mangle" ] && exit 0

# Создаем таблицу unblock для ipset ip4
ipset4_create_table

if fastnet_enabled ; then
	ip4save | grep "\-j CONNMARK" | grep -qE "mark|${table_name}" || {
		# Без отключения ускорителей fastnat и hwnat
		logger "Программное и аппаратное ускорение ПОДКЛЮЧЕНО."
		ip4_firewall_mark_rules_create
	}
else
	ip4save | grep "\j MARK" | grep -q "${table_name}" || {
		# С отключением fastnat и ускорителей hwnat
		logger "Программное и аппаратное ускорение ОТКЛЮЧЕНО!"
		ip4_firewall_mark_rules_tcp_udp_on
	}
fi
exit 0
