#!/bin/sh
. /opt/bin/unblock_lib

adblock_file="/opt/etc/adblock.dnsmasq"
tmp_file="/opt/tmp/kvas_hosts"
ads_sources_file="/opt/etc/adblock.sources"

cat /dev/null > "${adblock_file}"
score=0
hosts=0
total=$(cat < "${ads_sources_file}" | sed '/^$/d; /^#/d' | wc -l )

[ -z "${1}" ] && echo "Загрузка доменнов для блокировки из источников..."
while read -r line || [ -n "${line}" ]; do

	[  -z "${line}" ] && continue
	[ "${line::1}" = "#" ] && continue

	curl "${line}" -o "${tmp_file}" &>/dev/null
	cat < "${tmp_file}" \
		| sed -ne "/^\(0.0.0.0\|127.0.0.1\) [a-z]/p;" \
		| cut -d" " -f2  \
		| sed 's/^\(.*\)/server=\/\.\1\//g;'\
		>> "${adblock_file}"

	score=$((score+1))
	progress_bar "${score}" "${total}" "ссылок"

done < "${ads_sources_file}"
printf "\n"
print_line
ready "Обработка данных..."
cat < "${adblock_file}" | sort -u > "${tmp_file}"
cat "${tmp_file}" > "${adblock_file}"
list_unblock=$(cat < "/opt/etc/kvas.list" | tr '\n' '|' )
sed -r -i '/'"${list_unblock::-1}"'/d' "${adblock_file}"
rm "${tmp_file}"
[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"
