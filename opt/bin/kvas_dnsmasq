#!/bin/sh
# формируем из записей kvas.list специальные записи
# для конфигурационного файла dnsmasq типа "ipset=/хост/unblock"

#--------------------------------------------------------------
# обнуляем список разблокировки БС
#--------------------------------------------------------------
cat /dev/null > /opt/etc/unblock.dnsmasq

while read -r line || [ -n "${line}" ]; do
  add=1
  # удаляем из строки комментарии - все что встречается после символа # и сам символ
  line=$(echo "${line}" | sed 's/#.*$//g' | tr -s ' ' )
  #  пропускаем пустые строки и строки с комментариями
  [ -z "${line}" ] && continue
  #  пропускаем строки с комментариями
  [ "${line::1}" = "#" ] && continue

  # пропускаем из обработки IP адреса
  echo "${line}" | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' && continue
  host=$(echo "${line}" | sed 's/^.*\.\(.*\.\w\{2,6\}\)$/\1/')
  if [ -n "$(echo "${host}" | grep '*')" ]; then
  	host=$(echo "${host}" | sed 's/\*//; s/\./\\./g')
  	echo "ipset=/:.*${host}:/unblock" >> /opt/etc/unblock.dnsmasq
  else
    echo "ipset=/${host}/unblock" >> /opt/etc/unblock.dnsmasq
  fi

done < @UNBLOCK_LIST
