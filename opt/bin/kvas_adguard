#!/bin/sh

ipset=''; domain='';
adguard_config=/opt/etc/AdGuardHome/AdGuardHome.yaml

while read -r line || [ -n "$line" ]; do
	[ -z "${line}" ] && continue
	[ "${line:0:1}" = "#" ] && continue

	echo "${line}" | grep -Eq '([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{1,4}' && continue
	line=$(echo "${line}" | sed 's/\*//;')
	[ -n "${domain}" ] && domain="${domain},${line}" || domain="${line}"

done < /opt/etc/hosts.list

[ -n "${domain}" ] && ipset="- ${domain}\/unblock"
[ -z "${ipset}" ] && ipset="[]"

if grep -q 'ipset:' "${adguard_config}"; then
	#	если блок ipset присутствует в файле конфигурации
	sed -i "s/\(ipset: \).*/\1\n\t${ipset}/"  "${adguard_config}"
else
	#	если блок ipset отсуствует в файле конфигурации
	sed -i "s/\(.*\)\(^tls:.*\)/\1  ipset: \n\t${ipset}\n\2/" "${adguard_config}"
fi
